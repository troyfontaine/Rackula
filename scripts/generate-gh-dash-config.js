#!/usr/bin/env node

/**
 * Generate .gh-dash.yml configuration with dynamic milestone detection.
 *
 * Usage: node scripts/generate-gh-dash-config.js
 *
 * This script:
 * 1. Reads current version from package.json
 * 2. Queries GitHub API for open milestones
 * 3. Finds the next milestone (first > current version with open issues)
 * 4. Generates .gh-dash.yml with the detected milestone
 */

import { readFileSync, writeFileSync } from "fs";
import { execSync } from "child_process";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const ROOT_DIR = join(__dirname, "..");

/**
 * Parse semver string into comparable parts
 */
function parseSemver(version) {
  const match = version.replace(/^v/, "").match(/^(\d+)\.(\d+)\.(\d+)/);
  if (!match) return null;
  return {
    major: parseInt(match[1], 10),
    minor: parseInt(match[2], 10),
    patch: parseInt(match[3], 10),
  };
}

/**
 * Compare two semver versions
 * Returns: -1 if a < b, 0 if a == b, 1 if a > b
 */
function compareSemver(a, b) {
  if (a.major !== b.major) return a.major - b.major;
  if (a.minor !== b.minor) return a.minor - b.minor;
  return a.patch - b.patch;
}

/**
 * Get current version from package.json
 */
function getCurrentVersion() {
  const packagePath = join(ROOT_DIR, "package.json");
  const pkg = JSON.parse(readFileSync(packagePath, "utf-8"));
  return pkg.version;
}

/**
 * Fetch open milestones from GitHub API
 */
function fetchMilestones() {
  try {
    const output = execSync(
      "gh api repos/RackulaLives/Rackula/milestones --jq '.[] | select(.state==\"open\" and .open_issues > 0) | {title: .title, open_issues: .open_issues}'",
      { encoding: "utf-8", stdio: ["pipe", "pipe", "pipe"] },
    );

    // Parse JSONL output (one JSON object per line)
    return output
      .trim()
      .split("\n")
      .filter((line) => line.trim())
      .map((line) => JSON.parse(line));
  } catch (error) {
    console.error("Warning: Could not fetch milestones from GitHub API.");
    console.error("Using fallback milestone v0.7.0");
    return [{ title: "v0.7.0", open_issues: 1 }];
  }
}

/**
 * Find the next milestone (lowest version > current with open issues)
 */
function findNextMilestone(currentVersion, milestones) {
  const current = parseSemver(currentVersion);
  if (!current) {
    console.error(`Could not parse current version: ${currentVersion}`);
    return milestones[0]?.title || "v0.7.0";
  }

  // Filter to milestones > current version
  const futureMilestones = milestones
    .map((m) => ({ ...m, semver: parseSemver(m.title) }))
    .filter((m) => m.semver && compareSemver(m.semver, current) > 0)
    .sort((a, b) => compareSemver(a.semver, b.semver));

  if (futureMilestones.length === 0) {
    console.warn("No future milestones found, using first available");
    return milestones[0]?.title || "v0.7.0";
  }

  return futureMilestones[0].title;
}

/**
 * Generate the gh-dash config YAML
 */
function generateConfig(nextMilestone, currentVersion) {
  const timestamp = new Date().toISOString().split("T")[0];

  return `# AUTO-GENERATED by scripts/generate-gh-dash-config.js
# Generated: ${timestamp}
# Current version: ${currentVersion}
# Next milestone: ${nextMilestone}
#
# Regenerate with: node scripts/generate-gh-dash-config.js

defaults:
  view: issues
  prsLimit: 20
  issuesLimit: 20
  refetchIntervalMinutes: 5

prSections:
  - title: "Failing CI"
    filters: "is:open status:failure"
  - title: "All Open"
    filters: "is:open"

issuesSections:
  - title: "Ready"
    filters: "is:open label:ready"
  - title: "In Progress"
    filters: "is:open label:in-progress"
  - title: "${nextMilestone}"
    filters: "is:open milestone:${nextMilestone}"
  - title: "Priority"
    filters: "is:open label:priority:high,priority:urgent"
  - title: "Spikes"
    filters: "is:open label:spike"

repoPaths:
  RackulaLives/*: ~/code/projects/Rackula/*

keybindings:
  universal:
    - key: e
      command: zed {{.RepoPath}}
  prs:
    - key: c
      builtin: checkout
    - key: b
      command: open "https://github.com/{{.RepoName}}/pull/{{.PrNumber}}"
    - key: "y"
      command: echo "{{.PrNumber}}" | pbcopy
  issues:
    - key: b
      command: open "https://github.com/{{.RepoName}}/issues/{{.IssueNumber}}"
    - key: "y"
      command: echo "{{.IssueNumber}}" | pbcopy
`;
}

// Main execution
function main() {
  console.log("Generating gh-dash configuration...\n");

  const currentVersion = getCurrentVersion();
  console.log(`Current version: ${currentVersion}`);

  const milestones = fetchMilestones();
  console.log(`Found ${milestones.length} open milestone(s) with issues`);

  const nextMilestone = findNextMilestone(currentVersion, milestones);
  console.log(`Next milestone: ${nextMilestone}\n`);

  const config = generateConfig(nextMilestone, currentVersion);
  const outputPath = join(ROOT_DIR, ".gh-dash.yml");

  writeFileSync(outputPath, config, "utf-8");
  console.log(`Generated: ${outputPath}`);
  console.log("\nConfig sections:");
  console.log("  PRs: Failing CI, All Open");
  console.log(
    `  Issues: Ready, In Progress, ${nextMilestone}, Priority, Spikes`,
  );
  console.log("\nKeybindings:");
  console.log("  e - Open in Zed");
  console.log("  y - Copy issue/PR number");
  console.log("  b - Open in browser");
  console.log("  c - Checkout PR (PRs only)");
}

main();
