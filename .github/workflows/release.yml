name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Extract version number
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"  # Remove 'v' prefix
          echo "version=$VERSION_NUM" >> $GITHUB_OUTPUT

      - name: Validate changelog entry exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! grep -q "^## \[$VERSION\]" CHANGELOG.md; then
            echo "ERROR: No changelog entry found for version $VERSION"
            echo "Please update CHANGELOG.md before releasing."
            echo ""
            echo "Expected format:"
            echo "## [$VERSION] - YYYY-MM-DD"
            exit 1
          fi
          echo "Changelog entry found for version $VERSION"

      - name: Extract changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract the section between this version header and the next version header
          # Uses awk to capture everything between ## [X.Y.Z] and the next ## [
          NOTES=$(awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)

          # Remove leading/trailing whitespace
          NOTES=$(echo "$NOTES" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

          # Handle multiline output for GitHub Actions
          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --notes "${{ steps.changelog.outputs.notes }}"
