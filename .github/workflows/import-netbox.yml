name: Import NetBox Devices

on:
  workflow_dispatch:
    inputs:
      vendor:
        description: 'Vendor name (case-sensitive, e.g., Ubiquiti, Dell, Synology)'
        required: true
        type: string
      slug:
        description: 'Device slug to import (leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run only (no changes)'
        required: false
        type: boolean
        default: true

jobs:
  import:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - run: npm install -g npm@11

      - name: Install dependencies
        run: npm ci

      - name: Run import script
        id: import
        run: |
          FLAGS="--vendor ${{ inputs.vendor }}"

          if [ -n "${{ inputs.slug }}" ]; then
            FLAGS="$FLAGS --slug ${{ inputs.slug }}"
          else
            FLAGS="$FLAGS --all"
          fi

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi

          echo "Running: npx tsx scripts/import-netbox-devices.ts $FLAGS"
          npx tsx scripts/import-netbox-devices.ts $FLAGS

      - name: Process images
        if: inputs.dry_run == false
        run: npm run process-images

      - name: Check for changes
        if: inputs.dry_run == false
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: inputs.dry_run == false && steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat(devices): import ${{ inputs.vendor }} devices from NetBox'
          title: 'feat(devices): Import ${{ inputs.vendor }} devices from NetBox'
          body: |
            ## Summary
            Automated import of ${{ inputs.vendor }} devices from the NetBox devicetype-library.

            **Vendor:** ${{ inputs.vendor }}
            **Device:** ${{ inputs.slug || 'All available' }}

            ## Checklist
            - [ ] Review imported device definitions
            - [ ] Verify images render correctly
            - [ ] Update `bundledImages.ts` if needed
            - [ ] Run tests locally

            ---
            ðŸ¤– Generated by NetBox Import Action
          branch: import/${{ inputs.vendor }}-devices
          labels: feature,area:devices
